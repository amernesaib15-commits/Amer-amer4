<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الاستثمار والمهام</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f0f4f8; }
        .bg-card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #4a90e2; }
        .btn-primary:hover { background-color: #357bd2; }
        .modal { display: none; }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-6 md:p-10">

    <script type="module">
        // استيراد مكتبات Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // متغيرات عامة توفرها البيئة
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // تهيئة خدمات Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // عناصر واجهة المستخدم
        const dashboard = document.getElementById('dashboard');
        const balanceDisplay = document.getElementById('balance');
        const userIdDisplay = document.getElementById('user-id');
        const depositBtn = document.getElementById('deposit-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const referralInput = document.getElementById('referral-input');
        const copyReferralBtn = document.getElementById('copy-referral-btn');
        const plansContainer = document.getElementById('plans-container');
        const tasksContainer = document.getElementById('tasks-container');
        const depositModal = document.getElementById('deposit-modal');
        const withdrawModal = document.getElementById('withdraw-modal');
        const closeModalBtns = document.querySelectorAll('.close-modal');
        const depositConfirmBtn = document.getElementById('deposit-confirm-btn');
        const withdrawConfirmBtn = document.getElementById('withdraw-amount-input');
        const withdrawAmountInput = document.getElementById('withdraw-amount-input');
        
        let userId = '';
        let userBalance = 0;
        const depositAmount = 100; // قيمة الإيداع الثابتة للمحاكاة
        const referralBonus = 5; // مكافأة الإحالة

        // خطط الاستثمار (قابلة للتعديل)
        const investmentPlans = [
            { id: 'plan1', name: 'الخطة الأساسية', price: 10, dailyProfit: 0.5, duration: 30 },
            { id: 'plan2', name: 'الخطة الفضية', price: 50, dailyProfit: 2.5, duration: 30 },
            { id: 'plan3', name: 'الخطة الذهبية', price: 100, dailyProfit: 5, duration: 30 },
        ];

        // المهام اليومية (قابلة للتعديل)
        const dailyTasks = [
            { id: 'task1', title: 'شاهد فيديو إعلاني', reward: 0.5 },
            { id: 'task2', title: 'أجب عن استطلاع قصير', reward: 1.0 },
            { id: 'task3', title: 'سجل إعجاباً بصفحتنا على فيسبوك', reward: 0.25 },
        ];
        
        // دالة للمصادقة
        async function handleAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("خطأ في مصادقة Firebase:", error);
            }
        }
        handleAuth();

        // معالجة رابط الإحالة عند الدخول
        async function handleReferral(referrerId) {
            const userProfileRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
            const userProfileSnap = await getDoc(userProfileRef);

            if (!userProfileSnap.exists()) {
                await setDoc(userProfileRef, { balance: referralBonus, createdAt: new Date() });

                const referrerProfileRef = doc(db, "artifacts", appId, "users", referrerId, "profile", "data");
                const referrerProfileSnap = await getDoc(referrerProfileRef);

                if (referrerProfileSnap.exists()) {
                    await setDoc(referrerProfileRef, { balance: referrerProfileSnap.data().balance + referralBonus }, { merge: true });
                }

                showMessage(`تهانينا! لقد حصلت على ${referralBonus} دولار كمكافأة إحالة.`, 'success');
            }
        }

        // الاستماع لحالة المصادقة
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `معرف المستخدم: ${userId}`;
                dashboard.classList.remove('hidden');
                
                const urlParams = new URLSearchParams(window.location.search);
                const referrerId = urlParams.get('ref');
                if (referrerId && referrerId !== userId) {
                    await handleReferral(referrerId);
                }
                
                // عرض رابط الدعوة
                const referralUrl = `${window.location.origin}${window.location.pathname}?ref=${userId}`;
                referralInput.value = referralUrl;

                setupRealtimeListeners();
            }
        });

        // إعداد المستمعين على Firestore
        function setupRealtimeListeners() {
            // الاستماع لتغيرات رصيد المستخدم
            const userRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
            onSnapshot(userRef, async (docSnap) => {
                if (docSnap.exists()) {
                    userBalance = docSnap.data().balance || 0;
                } else {
                    await setDoc(userRef, { balance: 0, lastDailyProfit: null, lastTaskDate: null });
                    userBalance = 0;
                }
                balanceDisplay.textContent = `${userBalance.toFixed(2)} دولار`;
                
                // حساب الأرباح اليومية
                processDailyProfit();
            });

            // عرض خطط الاستثمار
            renderInvestmentPlans();

            // عرض المهام اليومية
            renderDailyTasks();
        }

        // معالجة الأرباح اليومية
        async function processDailyProfit() {
            const now = new Date();
            const today = now.toLocaleDateString();
            
            const userRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
            const userSnap = await getDoc(userRef);
            const lastProfitDate = userSnap.data()?.lastDailyProfit;
            
            if (lastProfitDate !== today) {
                const investmentsRef = collection(db, "artifacts", appId, "users", userId, "investments");
                const investmentSnap = await getDocs(investmentsRef);
                let totalDailyProfit = 0;

                investmentSnap.forEach((invDoc) => {
                    const inv = invDoc.data();
                    const startDate = inv.startDate.toDate();
                    const endDate = inv.endDate.toDate();

                    if (now >= startDate && now <= endDate) {
                        totalDailyProfit += inv.dailyProfit;
                    }
                });

                if (totalDailyProfit > 0) {
                    await setDoc(userRef, { balance: userBalance + totalDailyProfit, lastDailyProfit: today }, { merge: true });
                    showMessage(`تهانينا! لقد حصلت على ${totalDailyProfit.toFixed(2)} دولار كأرباح يومية.`, 'success');
                }
            }
        }

        // عرض خطط الاستثمار
        function renderInvestmentPlans() {
            plansContainer.innerHTML = '';
            investmentPlans.forEach(plan => {
                const planEl = document.createElement('div');
                planEl.className = 'bg-card p-6 flex flex-col items-center text-center';
                planEl.innerHTML = `
                    <h3 class="text-2xl font-bold mb-2">${plan.name}</h3>
                    <p class="text-gray-600 mb-4">استثمر ${plan.price} دولار لمدة ${plan.duration} يومًا</p>
                    <div class="flex items-center justify-center mb-4">
                        <span class="text-3xl font-bold text-green-600 ml-2">${plan.dailyProfit.toFixed(2)}</span>
                        <span class="text-xl text-gray-500">دولار/يوم</span>
                    </div>
                    <button data-plan-id="${plan.id}" class="invest-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full transition duration-300">
                        استثمر الآن
                    </button>
                `;
                plansContainer.appendChild(planEl);
            });
            document.querySelectorAll('.invest-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleInvest(e.target.dataset.planId));
            });
        }

        // عرض المهام اليومية
        async function renderDailyTasks() {
            tasksContainer.innerHTML = '';
            const userProfileRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
            const userProfileSnap = await getDoc(userProfileRef);
            const lastTaskDate = userProfileSnap.data()?.lastTaskDate;
            const today = new Date().toLocaleDateString();
            const canCompleteTask = lastTaskDate !== today;

            dailyTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'bg-card p-6 mb-4 flex flex-col md:flex-row justify-between items-center text-center md:text-right';
                taskEl.innerHTML = `
                    <div class="mb-4 md:mb-0">
                        <h3 class="text-xl font-bold mb-2">${task.title}</h3>
                        <p class="text-gray-600">مكافأة: ${task.reward.toFixed(2)} دولار</p>
                    </div>
                    <button data-task-id="${task.id}" class="complete-task-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-full transition duration-300 ${!canCompleteTask ? 'opacity-50 cursor-not-allowed' : ''}" ${!canCompleteTask ? 'disabled' : ''}>
                        أنجز المهمة
                    </button>
                `;
                tasksContainer.appendChild(taskEl);
            });
            document.querySelectorAll('.complete-task-btn').forEach(btn => {
                btn.addEventListener('click', (e) => completeTask(e.target.dataset.taskId));
            });
        }

        // معالجة الاستثمار
        async function handleInvest(planId) {
            const plan = investmentPlans.find(p => p.id === planId);
            if (!plan) return;

            if (userBalance < plan.price) {
                showMessage('رصيدك غير كافٍ للاستثمار في هذه الخطة.', 'error');
                return;
            }

            try {
                // خصم المبلغ من الرصيد
                const userRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
                await setDoc(userRef, { balance: userBalance - plan.price }, { merge: true });

                // إضافة خطة استثمار جديدة
                const investmentsRef = collection(db, "artifacts", appId, "users", userId, "investments");
                const now = new Date();
                await addDoc(investmentsRef, {
                    planId: plan.id,
                    amount: plan.price,
                    dailyProfit: plan.dailyProfit,
                    startDate: now,
                    endDate: new Date(now.getTime() + (plan.duration * 24 * 60 * 60 * 1000)),
                    status: 'active'
                });

                showMessage(`تم الاستثمار بنجاح في ${plan.name}، سيتم إضافة الأرباح يومياً لمدة 30 يومًا.`, 'success');
            } catch (error) {
                console.error("خطأ في عملية الاستثمار:", error);
                showMessage("حدث خطأ أثناء الاستثمار. الرجاء المحاولة مرة أخرى.", 'error');
            }
        }

        // إنجاز مهمة يومية
        async function completeTask(taskId) {
            const task = dailyTasks.find(t => t.id === taskId);
            if (!task) return;

            const userProfileRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
            const userProfileSnap = await getDoc(userProfileRef);
            const lastTaskDate = userProfileSnap.data()?.lastTaskDate;
            const today = new Date().toLocaleDateString();

            if (lastTaskDate === today) {
                showMessage('لقد أنجزت مهمتك اليومية بالفعل. عد غداً!', 'error');
                return;
            }

            try {
                await setDoc(userProfileRef, { 
                    balance: userBalance + task.reward,
                    lastTaskDate: today
                }, { merge: true });
                
                showMessage(`تهانينا! لقد حصلت على ${task.reward.toFixed(2)} دولار من إنجاز المهمة.`, 'success');
                renderDailyTasks(); // لتحديث حالة الزر
            } catch (error) {
                console.error("خطأ في إنجاز المهمة:", error);
                showMessage("حدث خطأ أثناء إنجاز المهمة. الرجاء المحاولة مرة أخرى.", 'error');
            }
        }

        // فتح وإغلاق النماذج (Modals)
        depositBtn.addEventListener('click', () => {
            depositModal.classList.remove('hidden');
        });

        withdrawBtn.addEventListener('click', () => {
            withdrawModal.classList.remove('hidden');
        });

        closeModalBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                depositModal.classList.add('hidden');
                withdrawModal.classList.add('hidden');
            });
        });

        // معالجة الإيداع
        depositConfirmBtn.addEventListener('click', async () => {
            try {
                const userRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
                await setDoc(userRef, { balance: userBalance + depositAmount }, { merge: true });
                showMessage(`تم إيداع ${depositAmount} دولار بنجاح.`, 'success');
                depositModal.classList.add('hidden');
            } catch (error) {
                console.error("خطأ في الإيداع:", error);
                showMessage("فشل الإيداع. الرجاء المحاولة مرة أخرى.", 'error');
            }
        });

        // معالجة السحب
        withdrawConfirmBtn.addEventListener('click', async () => {
            const amountToWithdraw = parseFloat(withdrawAmountInput.value);
            if (isNaN(amountToWithdraw) || amountToWithdraw <= 0 || amountToWithdraw > userBalance) {
                showMessage('المبلغ غير صالح أو يفوق رصيدك.', 'error');
                return;
            }

            try {
                const userRef = doc(db, "artifacts", appId, "users", userId, "profile", "data");
                await setDoc(userRef, { balance: userBalance - amountToWithdraw }, { merge: true });
                showMessage(`تم طلب سحب بقيمة ${amountToWithdraw.toFixed(2)} دولار. سيتم المعالجة قريباً.`, 'success');
                withdrawModal.classList.add('hidden');
            } catch (error) {
                console.error("خطأ في السحب:", error);
                showMessage("فشل السحب. الرجاء المحاولة مرة أخرى.", 'error');
            }
        });
        
        // توليد ونسخ رابط الإحالة
        copyReferralBtn.addEventListener('click', () => {
            referralInput.select();
            document.execCommand('copy');
            showMessage("تم نسخ رابط الدعوة بنجاح!", 'success');
        });

        // عرض رسالة إشعار مؤقتة
        function showMessage(message, type) {
            const messageBox = document.createElement('div');
            messageBox.textContent = message;
            messageBox.className = `fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-lg text-white shadow-lg transition-transform duration-300 z-50`;
            if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            }
            document.body.appendChild(messageBox);
            setTimeout(() => {
                messageBox.classList.add('translate-y-20');
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, 3000);
        }
    </script>

    <div id="main-container" class="max-w-4xl mx-auto p-4 md:p-8">
        <div id="dashboard" class="hidden bg-white rounded-xl shadow-lg p-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4">
                <h1 class="text-3xl font-bold text-gray-800">لوحة التحكم</h1>
                <div class="flex items-center space-x-4 space-x-reverse mt-4 md:mt-0">
                    <div class="flex flex-col items-center">
                        <span class="text-xl text-gray-500">رصيدك</span>
                        <span id="balance" class="text-3xl font-bold text-green-600">0.00 دولار</span>
                    </div>
                    <button id="deposit-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                        إيداع
                    </button>
                    <button id="withdraw-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                        سحب
                    </button>
                </div>
            </div>
            
            <p id="user-id" class="text-sm text-gray-500 text-left mb-6"></p>

            <div id="referral-container" class="flex flex-col md:flex-row items-center justify-between mb-8 p-4 bg-gray-100 rounded-lg">
                <p class="text-gray-700 font-bold mb-2 md:mb-0">ادعُ أصدقاءك واكسب 5 دولارات لكل دعوة!</p>
                <div class="flex flex-col items-center md:flex-row space-y-2 md:space-y-0 md:space-x-4 md:space-x-reverse">
                    <input type="text" id="referral-input" class="p-2 w-full md:w-64 border rounded-md text-sm text-center md:text-right" readonly>
                    <button id="copy-referral-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 rounded-md transition duration-300">
                        نسخ
                    </button>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4 text-center">خططنا الاستثمارية</h2>
                <div id="plans-container" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    <div class="flex justify-center items-center h-48 text-gray-500">
                        جارٍ تحميل الخطط...
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4 text-center">المهام اليومية</h2>
                <div id="tasks-container" class="flex flex-col gap-4">
                    <div class="flex justify-center items-center h-24 text-gray-500">
                        جارٍ تحميل المهام...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نموذج الإيداع -->
    <div id="deposit-modal" class="modal fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50">
        <div class="bg-card p-8 w-full max-w-sm text-center">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">إيداع رصيد</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <p class="text-gray-600 mb-4">للمحاكاة، سيتم إضافة 100 دولار إلى رصيدك.</p>
            <button id="deposit-confirm-btn" class="btn-primary text-white py-2 px-4 rounded-md">تأكيد الإيداع</button>
        </div>
    </div>

    <!-- نموذج السحب -->
    <div id="withdraw-modal" class="modal fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50">
        <div class="bg-card p-8 w-full max-w-sm text-center">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">سحب الأرباح</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <div class="mb-4">
                <label for="withdraw-amount-input" class="block text-sm font-medium text-gray-700 mb-2">أدخل المبلغ</label>
                <input type="number" id="withdraw-amount-input" class="p-2 w-full border rounded-md" placeholder="مثال: 50.00" step="0.01">
            </div>
            <button id="withdraw-confirm-btn" class="btn-primary text-white py-2 px-4 rounded-md">تأكيد السحب</button>
        </div>
    </div>

</body>
</html>
